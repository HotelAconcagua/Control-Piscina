<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ingreso a Piscina</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la librería SheetJS (xlsx) para leer archivos de Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Carga de Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Fuente Inter -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FAFAFA; } /* Fondo blanco para contraste */
        /* Nuevo Degradado Caribeño: de Amarillo Suave a Azul Profundo */
        .header-bg { 
            background-image: linear-gradient(to right top, #FFC107, #00BCD4, #0D47A1); /* Sol, Turquesa, Azul Profundo */
            height: 12rem; /* Altura para el efecto de gradiente */
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.2);
        } 
        /* Eliminamos glass-card y su blur para mejorar legibilidad */
        .guest-card { transition: all 0.2s; }
        .guest-card-checked { background-color: #e0f7fa; border-left-color: #00BCD4; } /* Turquesa claro para marcado */
        .guest-card-unchecked { background-color: white; border-left-color: #e5e7eb; } /* Blanco para pendiente */
        
        /* NUEVO ESTADO DE ALERTA (NARANJA) */
        .guest-card-alert { background-color: #fffbeb; border-left-color: #f97316; } /* Amber-50 / Orange-500 */
        
        .check-button {
            width: 3rem; 
            height: 3rem;
            min-width: 3rem;
            border-radius: 9999px; /* Circular */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.15s ease;
        }
        /* Color de fondo del contenedor principal */
        #app { background-color: #FAFAFA; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen bg-gray-50 flex flex-col items-center">
        
        <!-- Encabezado Fijo y Controles (Estilo Caribeño/Acuático) -->
        <header class="w-full header-bg p-4 sticky top-0 z-10">
            
            <!-- Contenedor del Título y Logo -->
            <!-- LOGO: Oculto en móvil, visible en tabletas (sm:block) para evitar superposición. -->
            <div class="relative flex items-center justify-center pt-2 mb-4"> <!-- MARGEN AJUSTADO A mb-4 -->
                
                <!-- [INICIO] COLOCAR LOGO AQUÍ -->
                <!-- RUTA FINAL Y CORREGIDA: 'logo1.png' -->
                <img id="hotel-logo" 
                     src="logo1.png" 
                     alt="Logo del Hotel" 
                     onerror="this.style.display='none'"
                     class="absolute left-0 h-10 w-auto object-contain rounded-lg hidden sm:block"
                >
                <!-- [FIN] COLOCAR LOGO AQUÍ -->
                
                <!-- Título Centrado -->
                <h1 class="text-xl font-extrabold text-white text-center">Control de Ingreso a Piscina</h1>
            </div>

            <!-- Controles Flotantes sobre el Header Background -->
            <!-- POSICIÓN AJUSTADA A top-14 -->
            <div class="absolute w-full max-w-xl left-1/2 transform -translate-x-1/2 top-14 px-4">
                
                <!-- 1. BUSCADOR Y BOTONES (FILA PRINCIPAL DE CONTROLES) -->
                <div class="flex items-center space-x-2 w-full">
                    
                    <!-- Barra de Búsqueda (Flex-grow para ocupar el espacio principal) -->
                    <div class="relative flex-grow">
                        <input type="text" id="search-input" placeholder="Buscar por Nombre o Habitación..." 
                               class="w-full p-3 pl-10 border-2 border-white rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-inner"
                               oninput="window.searchGuests(this.value)">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>

                    <!-- Botón de Carga (XLS/XLSX - Color SOLICITADO: #27CCF5) -->
                    <input type="file" id="file-input" accept=".xlsx, .xls, .xlsm, .xlsb, .ods" class="hidden" onchange="window.handleFileUpload(event)">
                    <button onclick="document.getElementById('file-input').click()"
                            id="upload-button"
                            class="p-3 bg-[#27CCF5] text-white rounded-xl font-semibold hover:bg-[#00B4D8] transition duration-150 shadow-md text-sm whitespace-nowrap min-w-[5rem]">
                        Cargar Lista
                    </button>
                </div>

                <!-- 2. CONTADORES Y ORDENAMIENTO (FILA SECUNDARIA) -->
                <div class="flex items-center mt-3 space-x-2">

                    <!-- Contadores (Fondo blanco sólido - Ocupa la mayor parte del espacio) -->
                    <div id="counter-card" class="text-sm p-3 rounded-xl shadow-xl bg-white border border-gray-200 flex-grow">
                        <div class="flex justify-between items-center text-gray-700">
                            <span id="guest-count" class="font-medium text-base">Total de Huéspedes: 0</span>
                            
                            <!-- Botones de Navegación Antiguos (Eliminados de aquí) -->
                            <div class="flex space-x-2 hidden"></div>
                        </div>
                        <div class="mt-1 text-xl font-bold text-green-700"> 
                            <span id="entered-count">Ingresados: 0</span>
                        </div>
                        
                        <!-- TAREA A: SELLO DE ÚLTIMA ACTUALIZACIÓN -->
                        <div class="mt-2 pt-2 border-t border-gray-100">
                            <span id="last-updated" class="text-xs text-gray-500">Cargando...</span>
                        </div>
                    </div>

                    <!-- Menú Desplegable de Ordenamiento (Ancho ajustado) -->
                    <div id="sort-controls" class="w-28 min-w-[7rem]"> 
                        <label for="sort-by" class="text-xs font-semibold text-white sr-only">Ordenar por:</label>
                        <select id="sort-by" onchange="window.sortGuests(this.value)" 
                                class="w-full p-3 text-sm rounded-xl border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-700 font-medium truncate">
                            <option value="name">Ordenar...</option> 
                            <option value="name">Nombre</option>
                            <option value="room">Habitación</option>
                            <option value="checked">Ingreso</option> <!-- NUEVA OPCIÓN -->
                        </select>
                    </div>
                </div>

                <!-- 3. NUEVA FILA DE NAVEGACIÓN (Debajo del contador) -->
                <div class="flex justify-between items-center mt-2 space-x-2 w-full">
                    <button onclick="window.showHistoryView()" 
                            class="w-1/2 p-2 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600 transition shadow-md text-sm flex items-center justify-center">
                        <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3-.895-3-2 1.343-2 3-2zM21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.176A9.902 9.902 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                        Ver Histórico
                    </button>
                    <button onclick="window.showGraphView()" 
                            class="w-1/2 p-2 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600 transition shadow-md text-sm flex items-center justify-center">
                        <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M18 10H6" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 18h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                        Ver Gráficos
                    </button>
                </div>

            </div>
            
        </header>

        <!-- Contenedor del Checklist (AJUSTE CRÍTICO DEL MARGEN) -->
        <!-- MARGEN AJUSTADO A mt-[9rem] -->
        <main id="list-view-container" class="w-full max-w-xl p-4 space-y-3 pb-20 mt-[9rem]"> 
            <div id="loading-message" class="text-center p-8 text-gray-500">
                <svg class="animate-spin h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" ></path>
                </svg>
                <p class="mt-2">Iniciando base de datos...</p>
            </div>
            <div id="guest-list-container" class="space-y-3">
                <!-- Lista de huéspedes inyectada aquí -->
            </div>
        </main>
        
        <!-- VISTA 2: HISTORIAL DE REGISTROS -->
        <main id="history-view-container" class="w-full max-w-xl p-4 space-y-4 pb-20 mt-[9rem] hidden">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <button onclick="window.showListView()" class="text-blue-600 font-semibold hover:text-blue-800 transition flex items-center">
                    <svg class="h-5 w-5 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Volver al Checklist
                </button>
                <h2 class="text-xl font-bold text-gray-800">Historial Diario</h2>
            </div>
            
            <!-- Botón de Exportar Historial -->
            <button onclick="window.exportHistoryToCSV()" class="w-full p-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition duration-150 shadow-md flex items-center justify-center">
                <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                Exportar Historial a CSV (Excel)
            </button>
            
            <div id="history-stats-container" class="space-y-3">
                <!-- Estadísticas históricas cargadas aquí -->
                <p class="text-center text-gray-500">Cargando registros históricos...</p>
            </div>
            
            <!-- Botón de Borrado Masivo (Limpieza de Año) -->
            <div class="mt-8 pt-4 border-t border-red-200">
                <button onclick="window.showDeleteAllModal()" class="w-full p-3 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700 transition duration-150 shadow-md flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    Eliminar TODOS los Registros Históricos
                </button>
            </div>
        </main>

        <!-- VISTA 3: GRÁFICOS DE ESTADÍSTICAS -->
        <main id="graph-view-container" class="w-full max-w-xl p-4 space-y-4 pb-20 mt-[9rem] hidden">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <button onclick="window.showListView()" class="text-blue-600 font-semibold hover:text-blue-800 transition flex items-center">
                    <svg class="h-5 w-5 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Volver al Checklist
                </button>
                <h2 class="text-xl font-bold text-gray-800">Gráfico de Ingresos Diarios</h2>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                <p id="chart-status" class="text-center text-sm text-gray-500 mb-4">Gráfico de los últimos 30 días.</p>
                <div class="relative h-64 w-full">
                    <!-- Canvas donde Chart.js dibujará el gráfico -->
                    <canvas id="daily-chart"></canvas>
                </div>
            </div>

            <div id="chart-message-area">
                <!-- Mensajes de error o datos insuficientes -->
            </div>
        </main>
        
        <!-- Mensajes de Notificación (simula alert()) -->
        <div id="notification-area" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-20">
        </div>

    </div>
    
    <!-- Modal de Confirmación para Carga de Datos -->
    <div id="upload-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-70">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirmar Carga de Lista</h3>
            <p class="text-gray-700 mb-6">
                **ATENCIÓN**: Al cargar esta nueva lista de <span id="modal-guest-count" class="font-bold">0</span> huéspedes, se **archivará el registro actual** y se **borrará toda la lista**. ¿Desea continuar?
            </p>
            <div class="flex justify-end space-x-3">
                <button onclick="window.closeConfirmModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                    <button id="modal-confirm-button" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition font-semibold">
                    Sí, Archivar y Cargar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmación para Borrado Masivo (Con Contraseña) -->
    <div id="delete-all-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-70">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md">
            <h3 class="text-xl font-bold text-red-600 mb-4">¡PELIGRO! Borrado Masivo de Datos</h3>
            <p class="text-gray-700 mb-4">
                Esta acción **eliminará de forma PERMANENTE todos los registros históricos** (logs diarios) de la base de datos.
            </p>
            <label for="delete-password" class="block text-sm font-medium text-gray-700 mb-2">
                Para confirmar, ingrese la contraseña maestra:
            </label>
            <input type="password" id="delete-password" 
                   class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 mb-6"
                   placeholder="Contraseña">
                   
            <div class="flex justify-between items-center">
                <button onclick="window.closeDeleteAllModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button id="modal-delete-button" disabled 
                        class="px-4 py-2 bg-red-300 text-white rounded-xl font-semibold cursor-not-allowed transition">
                    Confirmar y Borrar TODO
                </button>
            </div>
        </div>
    </div>


    <!-- Script de Firebase (Módulos) -->
    <script type="module">
        // Importación de módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, serverTimestamp, orderBy, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // --- CONFIGURACIÓN PARA EL HOSTING EN TU PROPIO SERVIDOR (GITHUB PAGES) ---
        // CLAVES DE TU PROYECTO FIREBASE 'control-piscina-48181'
        // =========================================================================
        
        // 2. Configuración de Firebase (CLAVES PÚBLICAS)
        const firebaseConfig = {
            apiKey: "AIzaSyD_vUGs0iDY0w45OlFjPCaOX58YI7J0xDI", 
            authDomain: "control-piscina-48181.firebaseapp.com", 
            projectId: "control-piscina-48181", 
            storageBucket: "control-piscina-48181.firebasestorage.app", 
            appId: "1:651276695583:web:02a25b22bcb52d5a05fd2a" 
        };
        
        // El token custom no se usa en hosting público. Se deja en null.
        const initialAuthToken = null; 
        
        // RUTA COMPARTIDA: Esta constante define la ubicación de los datos compartidos.
        const SHARED_COLLECTION_ID = "checklist_pool_data_v1";

        // --- CONTRASEÑA MAESTRA PARA BORRADO MASIVO ---
        const MASTER_PASSWORD = "sanlorenzo454"; 
        // =========================================================================
        // --- FIN DE CONFIGURACIÓN ---
        // =========================================================================

        let db;
        let auth;
        let currentUserId = null;
        let allGuests = []; // Almacena la lista completa de huéspedes.
        let parsedGuestData = []; // Almacena los datos del archivo CSV temporalmente.
        let currentSearchTerm = ''; // Variable global para guardar el término de búsqueda
        let currentSortBy = 'name'; // Variable global para guardar el criterio de ordenamiento (Default: 'name')
        let dailyChartInstance = null; // Instancia de Chart.js para evitar duplicados
        
        // NUEVO: Almacenamiento local del estado de alerta
        // Usaremos un Map para guardar el guestId y su estado (true si está en alerta, false si no)
        let alertState = new Map();

        // --- FUNCIONES GLOBALES DE UTILIDAD ---
        
        /** Normaliza una cadena removiendo acentos y convirtiendo a minúsculas para la búsqueda. */
        function normalizeStringForSearch(str) {
            if (!str) return '';
            // 1. Normaliza y remueve diacríticos (acentos)
            // 2. Convierte a minúsculas
            // 3. Permite la ñ (ñ se maneja con la búsqueda)
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }
        window.normalizeStringForSearch = normalizeStringForSearch; // Hacemos global para uso en oninput

        /** Formatea un string a Title Case (primera letra de cada palabra en mayúscula). */
        function toTitleCase(str) {
            // Aseguramos que el str esté limpio antes de formatear
            return str.toLowerCase().split(' ').map(function(word) {
                if (word.length === 0) return '';
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }
        
        /** Formatea el timestamp de Firebase a una cadena legible. */
        function formatFirebaseTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'Fecha desconocida';
            const date = timestamp.toDate();
            // Formato: 17/10/2025 16:20
            return date.toLocaleDateString('es-ES') + ' ' + date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }
        
        /** Formatea solo la fecha (dd/mm). */
        function formatFirebaseDateOnly(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
        }


        /** Muestra una notificación temporal. */
        window.showNotification = function(message, type = 'success') {
            const area = document.getElementById('notification-area');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const html = `
                <div class="${color} text-white px-4 py-2 rounded-xl shadow-xl text-sm mb-2 opacity-0 transition-opacity duration-300" 
                     style="min-width: 150px; text-align: center;">
                    ${message}
                </div>
            `;
            
            const notification = document.createElement('div');
            notification.innerHTML = html;
            const element = notification.firstElementChild;
            area.appendChild(element);

            // Mostrar
            setTimeout(() => { element.classList.remove('opacity-0'); }, 10);
            
            // Ocultar y eliminar
            setTimeout(() => {
                element.classList.add('opacity-0');
                element.addEventListener('transitionend', () => element.remove());
            }, 3000);
        }

        /** Inicializa Firebase y autenticación. */
        async function initializeFirebase() {
            // Lógica de inicialización (Mantenido)
            try {
                // Validación de configuración para el entorno público
                if (!firebaseConfig.apiKey || firebaseConfig.projectId.includes('PEGA TU VALOR')) {
                    document.getElementById('loading-message').innerHTML = '<p class="text-red-600 font-bold">ERROR DE CONFIGURACIÓN: Por favor, reemplace las claves de Firebase en el código JS.</p>';
                    window.showNotification("Fallo: ¡Configuración de Firebase incompleta!", 'error');
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticación anónima para obtener un user ID único
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    const userIdDisplay = document.getElementById('user-id-display');
                    const loadingMessage = document.getElementById('loading-message');

                    if (user) {
                        currentUserId = user.uid; 
                        // FIX: Comprobación de existencia del elemento antes de asignar textContent
                        if (userIdDisplay) {
                            userIdDisplay.textContent = `ID: ${currentUserId.substring(0, 8)}...`;
                        }
                        // Solo iniciamos la vista principal (Checklist)
                        window.showListView(); 
                    } else {
                        // FIX: Comprobación de existencia del elemento antes de asignar textContent
                        if (loadingMessage) {
                            loadingMessage.textContent = "Error de autenticación. Recargue la página.";
                        }
                        window.showNotification("Fallo en la autenticación.", 'error');
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                window.showNotification(`Error de inicio: ${error.message}`, 'error');
            }
        }
        // FIX: Asignar al objeto window para que window.onload la encuentre
        window.initializeFirebase = initializeFirebase;


        // --- MANEJO DE VISTAS (NAVIGATION) ---
        
        /** Alterna la vista a la lista de huéspedes. */
        window.showListView = function() {
            document.getElementById('list-view-container').classList.remove('hidden');
            document.getElementById('history-view-container').classList.add('hidden');
            document.getElementById('graph-view-container').classList.add('hidden');
            window.setupGuestListener(); // Asegura que se inicie la escucha de la lista activa
        }
        
        /** Alterna la vista al historial de registros. */
        window.showHistoryView = function() {
            document.getElementById('list-view-container').classList.add('hidden');
            document.getElementById('graph-view-container').classList.add('hidden');
            document.getElementById('history-view-container').classList.remove('hidden');
            window.setupHistoryListener(); // Inicia la escucha del historial
        }

        /** Alterna la vista a los gráficos. */
        window.showGraphView = function() {
            document.getElementById('list-view-container').classList.add('hidden');
            document.getElementById('history-view-container').classList.add('hidden');
            document.getElementById('graph-view-container').classList.remove('hidden');
            window.setupHistoryListener(true); // Inicia la escucha, pidiendo renderizar el gráfico
        }


        // --- LÓGICA DE FIRESTORE Y DATOS ---

        // RUTA DE LA LISTA ACTIVA (DIARIA)
        function getGuestsCollectionRef() {
            if (!db) return null;
            const collectionPath = `pool_data/${SHARED_COLLECTION_ID}/guests`;
            return collection(db, collectionPath);
        }
        
        // RUTA DE LOS REGISTROS HISTÓRICOS (LOGS)
        function getHistoryCollectionRef() {
            if (!db) return null;
            const historyCollectionPath = `pool_logs/stats_summary/daily_logs`;
            return collection(db, historyCollectionPath);
        }

        /** Borra todos los documentos de la colección actual (lista diaria). */
        async function clearAllGuests() {
            const guestRef = getGuestsCollectionRef();
            if (!guestRef) return;
            
            window.showNotification("Borrando lista anterior...", 'error');
            const snapshot = await getDocs(guestRef);
            
            const deletePromises = [];
            snapshot.docs.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref).catch(e => console.error("Fallo al borrar doc:", e)));
            });
            
            await Promise.all(deletePromises);
        }
        
        /** * ARCHIVA el resumen de la lista activa antes de borrarla y cargar la nueva.
         * Guarda SOLO los totales diarios.
         */
        async function archiveCurrentList() {
            const guestRef = getGuestsCollectionRef();
            if (allGuests.length === 0) return; // No archivar si la lista está vacía

            const enteredCount = allGuests.filter(guest => guest.isChecked).length;
            const totalGuests = allGuests.length;
            
            const historyRef = getHistoryCollectionRef();
            
            const newLogDoc = doc(historyRef);
            
            await setDoc(newLogDoc, {
                id: newLogDoc.id,
                dateLogged: serverTimestamp(),
                totalGuests: totalGuests,
                enteredCount: enteredCount,
                pendingCount: totalGuests - enteredCount // Calculado pero útil para el log
            });
        }


        /** Inicializa la base de datos con los datos proporcionados. */
        async function initializeGuestData(guestDataArray) {
            const uploadButton = document.getElementById('upload-button');
            uploadButton.disabled = true;
            uploadButton.textContent = "Archivando y Subiendo...";

            // 1. ARCHIVAR EL ESTADO ACTUAL
            await archiveCurrentList();
            
            // 2. BORRAR LA LISTA VIEJA
            window.showNotification("Borrando lista anterior...", 'error');
            await clearAllGuests(); // Ya no muestra notificación, solo borra.
            
            // 3. CARGAR LA LISTA NUEVA
            const guestRef = getGuestsCollectionRef();
            if (!guestRef) return;

            const batchSize = 50; 
            
            for (let i = 0; i < guestDataArray.length; i += batchSize) {
                const batchPromises = guestDataArray.slice(i, i + batchSize).map(guest => {
                    const docToCreate = doc(guestRef);
                    return setDoc(docToCreate, {
                        ...guest,
                        createdAt: serverTimestamp(),
                        id: docToCreate.id 
                    });
                });
                await Promise.all(batchPromises);
            }
            
            uploadButton.disabled = false;
            uploadButton.textContent = "Cargar Lista (XLS/XLSX)";
            window.showNotification("Lista de huéspedes actualizada y registro guardado.", 'success');
        }


        /** LÓGICA DE HISTORIAL: Carga y muestra los registros históricos. */
        window.setupHistoryListener = function(isGraphView = false) {
            const historyRef = getHistoryCollectionRef();
            const container = document.getElementById('history-stats-container');
            const graphMessageArea = document.getElementById('chart-message-area');

            if (!historyRef) return;
            
            // Usamos query para ordenar por fecha de forma descendente (más reciente primero)
            const q = query(historyRef, orderBy("dateLogged", "desc"));

            onSnapshot(q, (snapshot) => {
                let logs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // ... (El resto de la función se mantiene igual para la lógica de gráficos/historial)
                
                if (logs.length === 0) {
                    if(isGraphView) {
                         graphMessageArea.innerHTML = '<p class="text-center text-gray-500 p-8">No hay suficientes registros para generar el gráfico.</p>';
                    } else {
                        container.innerHTML = '<p class="text-center text-gray-500 p-8">Aún no hay registros históricos guardados.</p>';
                    }
                    return;
                }

                if (isGraphView) {
                    prepareAndRenderChart(logs);
                } else {
                    // Generar HTML para mostrar la lista de logs (Vista de Historial)
                    const html = logs.map(log => {
                        const dateStr = formatFirebaseTimestamp(log.dateLogged);
                        const enteredPct = log.totalGuests > 0 ? Math.round((log.enteredCount / log.totalGuests) * 100) : 0;
                        
                        return `
                            <div class="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-600">Registro guardado:</p>
                                        <p class="text-lg font-bold text-gray-900">${dateStr}</p>
                                    </div>
                                    <!-- Botón para Borrar Registro Individual -->
                                    <button onclick="window.showDeleteIndividualModal('${log.id}', '${dateStr}')" 
                                            class="p-1 text-sm text-red-500 hover:text-red-700 transition">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                                <div class="mt-3 grid grid-cols-2 gap-3 text-center">
                                    <div class="bg-blue-50 p-2 rounded-lg">
                                        <p class="text-xs text-blue-800 font-semibold">TOTAL</p>
                                        <p class="text-xl font-bold text-blue-900">${log.totalGuests}</p>
                                    </div>
                                    <div class="bg-green-50 p-2 rounded-lg">
                                        <p class="text-xs text-green-800 font-semibold">INGRESADOS</p>
                                        <p class="text-xl font-bold text-green-900">${log.enteredCount} (${enteredPct}%)</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    container.innerHTML = html;
                }
            }, (error) => {
                console.error("Error al escuchar historial:", error);
                if(isGraphView) {
                    graphMessageArea.innerHTML = '<p class="text-center text-red-600 p-8">Error al cargar datos del gráfico.</p>';
                } else {
                    container.innerHTML = '<p class="text-center text-red-600 p-8">Error al cargar el historial. Verifique su conexión o reglas de Firebase.</p>';
                }
            });
        }
        
        /** LÓGICA DE GRÁFICOS (CHART.JS) */
        
        /** Prepara los datos y llama a la función de renderizado del gráfico. */
        function prepareAndRenderChart(logs) {
            const chartMessageArea = document.getElementById('chart-message-area');
            
            // Reordenamos los logs por fecha ASCENDENTE para que el gráfico sea cronológico
            logs.sort((a, b) => a.dateLogged.toDate() - b.dateLogged.toDate());
            
            // Extraemos etiquetas y datasets
            const labels = logs.map(log => formatFirebaseDateOnly(log.dateLogged));
            const enteredData = logs.map(log => log.enteredCount);
            const totalData = logs.map(log => log.totalGuests);
            
            if (logs.length < 2) {
                 chartMessageArea.innerHTML = '<p class="text-center text-red-600 p-8">Se necesitan al menos 2 registros para dibujar un gráfico de tendencias.</p>';
                 if(dailyChartInstance) dailyChartInstance.destroy();
                 return;
            }

            renderChart(labels, enteredData, totalData);
        }

        /** Renderiza el gráfico de Chart.js */
        function renderChart(labels, enteredData, totalData) {
            const ctx = document.getElementById('daily-chart');

            // Destruye la instancia anterior si existe
            if (dailyChartInstance) {
                dailyChartInstance.destroy();
            }

            dailyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total de Huéspedes',
                            data: totalData,
                            borderColor: 'rgba(54, 162, 235, 1)', // Azul para el total
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Ingresados (Check-in)',
                            data: enteredData,
                            borderColor: 'rgba(75, 192, 192, 1)', // Verde/Cian para Ingresados
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad de Huéspedes'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fecha de Registro'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                             mode: 'index',
                             intersect: false,
                        }
                    }
                }
            });
        }


        /** LÓGICA DE GESTIÓN DE BORRADO Y EXPORTACIÓN */
        
        /** Exporta el historial de logs a un archivo CSV. */
        window.exportHistoryToCSV = async function() {
            const historyRef = getHistoryCollectionRef();
            
            try {
                const snapshot = await getDocs(historyRef);
                const logs = snapshot.docs.map(doc => doc.data());
                
                if (logs.length === 0) {
                    window.showNotification("No hay datos en el historial para exportar.", 'error');
                    return;
                }

                // Definimos el separador como punto y coma (;) para compatibilidad con Excel en LATAM
                const separator = ';'; 
                
                // 1. Encabezados
                let csv = `"Fecha";"Total Lista";"Ingresados";"Pendientes"\n`;

                // 2. Datos
                logs.forEach(log => {
                    const dateStr = formatFirebaseTimestamp(log.dateLogged);
                    const row = [
                        `"${dateStr}"`,
                        log.totalGuests,
                        log.enteredCount,
                        log.pendingCount
                    ];
                    csv += row.join(separator) + '\n';
                });

                // 3. Generación y descarga del Blob
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const fileName = `historial_ingresos_${new Date().toISOString().slice(0,10)}.csv`;
                
                const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.showNotification("Historial exportado correctamente.", 'success');
            } catch (error) {
                console.error("Error en la exportación:", error);
                window.showNotification("Fallo al exportar el historial.", 'error');
            }
        }
        
        /** Muestra el modal de borrado masivo. */
        window.showDeleteAllModal = function() {
            const modal = document.getElementById('delete-all-modal');
            const passwordInput = document.getElementById('delete-password');
            const deleteButton = document.getElementById('modal-delete-button');
            
            passwordInput.value = ''; // Limpiar campo
            deleteButton.disabled = true;
            deleteButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'cursor-pointer');
            deleteButton.classList.add('bg-red-300', 'cursor-not-allowed');
            
            modal.classList.remove('hidden');
            
            // Listener para verificar la contraseña
            passwordInput.oninput = function() {
                const isCorrect = passwordInput.value === MASTER_PASSWORD;
                deleteButton.disabled = !isCorrect;
                
                if (isCorrect) {
                    deleteButton.classList.remove('bg-red-300', 'cursor-not-allowed');
                    deleteButton.classList.add('bg-red-600', 'hover:bg-red-700', 'cursor-pointer');
                } else {
                    deleteButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'cursor-pointer');
                    deleteButton.classList.add('bg-red-300', 'cursor-not-allowed');
                }
            };
            
            deleteButton.onclick = async () => {
                window.closeDeleteAllModal();
                await window.deleteAllHistoryLogs();
            };
        }
        
        /** Cierra el modal de borrado masivo. */
        window.closeDeleteAllModal = function() {
            document.getElementById('delete-all-modal').classList.add('hidden');
        }
        
        /** Elimina todos los documentos del historial (usado por el modal maestro). */
        window.deleteAllHistoryLogs = async function() {
            const historyRef = getHistoryCollectionRef();
            if (!db) return;
            
            window.showNotification("Eliminando TODOS los registros...", 'error');
            
            const snapshot = await getDocs(historyRef);
            
            const deletePromises = [];
            snapshot.docs.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref).catch(e => console.error("Fallo al borrar log:", e)));
            });
            
            await Promise.all(deletePromises);
            window.showNotification("¡TODOS los registros históricos han sido eliminados permanentemente!", 'success');
        }
        
        /** Elimina un único registro histórico. */
        window.showDeleteIndividualModal = async function(logId, dateStr) {
            if (!confirm(`¿Está seguro de eliminar el registro del ${dateStr}? Esta acción es irreversible.`)) {
                return;
            }
            
            const historyRef = getHistoryCollectionRef();
            try {
                await deleteDoc(doc(historyRef, logId));
                window.showNotification(`Registro del ${dateStr} eliminado.`, 'success');
            } catch (error) {
                console.error("Fallo al eliminar registro individual:", error);
                window.showNotification("Error al eliminar el registro. Intente de nuevo.", 'error');
            }
        }
        
        
        /** Carga la lista de huéspedes en tiempo real. */
        window.setupGuestListener = function() {
            const guestRef = getGuestsCollectionRef();
            if (!guestRef) return;

            onSnapshot(guestRef, (snapshot) => {
                const loadingMessage = document.getElementById('loading-message');
                const emptyMessage = document.getElementById('empty-list-message');
                const lastUpdatedDisplay = document.getElementById('last-updated'); // Sello de tiempo

                if (snapshot.empty) {
                    allGuests = [];
                    loadingMessage?.remove();
                    if(emptyMessage) emptyMessage.classList.remove('hidden');
                    if(lastUpdatedDisplay) lastUpdatedDisplay.textContent = "No hay lista cargada.";
                    // Limpiar el estado de alerta cuando la lista se vacía
                    alertState.clear();
                } else {
                    if(emptyMessage) emptyMessage.classList.add('hidden');
                    loadingMessage?.remove();
                    
                    allGuests = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // TAREA A: LÓGICA DE SELLO DE TIEMPO
                    if(lastUpdatedDisplay) {
                        // Buscamos el 'createdAt' (debería ser el mismo para todos los de la carga)
                        if (allGuests[0] && allGuests[0].createdAt) {
                            const lastUploadDate = allGuests[0].createdAt.toDate();
                            const formattedDate = lastUploadDate.toLocaleDateString('es-ES') + ' ' + lastUploadDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                            lastUpdatedDisplay.textContent = `Lista cargada: ${formattedDate}`;
                        } else {
                            lastUpdatedDisplay.textContent = "Lista cargada (fecha no disp.)"; 
                        }
                    }

                    // APLICAR ORDENAMIENTO: Usamos la variable global currentSortBy
                    applySorting(allGuests);
                    
                    // Al recibir datos, volvemos a renderizar, aplicando el filtro actual.
                    renderList(allGuests); 
                }
            }, (error) => {
                // ESTA ES LA FUNCIÓN DONDE SE REGISTRA EL ERROR DE PERMISOS
                console.error("Error al escuchar la colección:", error);
                window.showNotification("Error de conexión a la lista. (Verifique reglas de seguridad)", 'error');
            });
        }
        
        /** Aplica el ordenamiento actual a la lista de huéspedes. */
        function applySorting(guests) {
            // El ordenamiento por Ingreso es más complejo ya que requiere alternar.
            if (currentSortBy === 'name') {
                guests.sort((a, b) => a.name.localeCompare(b.name));
            } else if (currentSortBy === 'room') {
                // Ordenar primero por el valor numérico de la habitación. Si no es numérico, usa string.
                guests.sort((a, b) => {
                    const roomA = parseInt(a.room, 10);
                    const roomB = parseInt(b.room, 10);

                    // Si ambos son números, ordenar numéricamente
                    if (!isNaN(roomA) && !isNaN(roomB)) {
                        return roomA - roomB;
                    }
                    // Si no, ordenar alfabéticamente (fallback)
                    return a.room.localeCompare(b.room);
                });
            } else if (currentSortBy === 'checked_asc') {
                // Ordenar por INGRESADO, poniendo PENDIENTES (false) primero (ascendente)
                guests.sort((a, b) => (a.isChecked === b.isChecked) ? 0 : a.isChecked ? 1 : -1);
            } else if (currentSortBy === 'checked_desc') {
                // Ordenar por INGRESADO, poniendo INGRESADOS (true) primero (descendente)
                guests.sort((a, b) => (a.isChecked === b.isChecked) ? 0 : a.isChecked ? -1 : 1);
            }
        }
        
        /**
         * Función llamada al cambiar el menú desplegable.
         */
        window.sortGuests = function(selectedOption) {
            if (selectedOption === 'checked') {
                // Lógica de alternancia para el ordenamiento por Ingreso
                if (currentSortBy === 'checked_desc') {
                    currentSortBy = 'checked_asc'; // Si ya está en descendente, cambia a ascendente (Pendientes Primero)
                } else {
                    currentSortBy = 'checked_desc'; // Por defecto, o si estaba en cualquier otro orden, Ingresados Primero
                }
            } else {
                currentSortBy = selectedOption;
            }
            
            // Reajustar la selección del dropdown para que muestre el valor "Ingreso" sin cambiar el valor interno
            const selectElement = document.getElementById('sort-by');
            if (selectElement.value !== 'name' && selectElement.value !== 'room') {
                // Si el valor actual es checked_asc/desc, forzamos que el display muestre 'checked'
                selectElement.value = 'checked';
            }


            // Al cambiar el criterio, reordenamos la lista actual y la volvemos a renderizar
            applySorting(allGuests);
            renderList(allGuests); 
        }

        /**
         * Actualiza el estado de check-in/check-out de un huésped en Firestore.
         * AHORA CON LÓGICA DE TRES ESTADOS (Blanco -> Verde -> Naranja -> Blanco).
         */
        window.toggleCheckin = async function(guestId, currentStatus) {
            const guestRef = getGuestsCollectionRef();
            
            if (!guestRef) {
                window.showNotification("Error: Base de datos no disponible.", 'error');
                return;
            }

            // Encuentra el huésped en la lista local para obtener el objeto completo si es necesario.
            const guest = allGuests.find(g => g.id === guestId);
            if (!guest) return;

            // Lógica para el ciclo Blanco -> Verde -> Naranja -> Blanco
            if (guest.isChecked === false) { // Estado actual: Blanco (Pendiente)
                // Pasa a Verde (Ingresado)
                alertState.delete(guestId); // Asegurarse de que no haya alerta activa.
                await setDoc(doc(guestRef, guestId), { isChecked: true }, { merge: true });
                // Firebase disparará onSnapshot y renderList se encargará del resto.
            } else if (alertState.has(guestId)) { // Estado actual: Naranja (Alerta)
                // Se toca de nuevo, se confirma el desmarcado. Pasa a Blanco (Pendiente)
                alertState.delete(guestId); // Quita el estado de alerta
                await setDoc(doc(guestRef, guestId), { isChecked: false }, { merge: true });
                // Firebase disparará onSnapshot y renderList se encargará del resto.
                window.showNotification(`${guest.name} desmarcado.`, 'success');
            } else { // Estado actual: Verde (Ingresado) -> Pasa a Naranja (Alerta)
                alertState.set(guestId, true); // Establece el estado de alerta localmente.
                renderList(allGuests); // Forzar un render para mostrar el color naranja.
                window.showNotification(`Toca de nuevo para desmarcar a ${guest.name}.`, 'warning');
                
                // Opcional: Si no se toca de nuevo en 3 segundos, quita la alerta y vuelve a verde.
                setTimeout(() => {
                    if (alertState.has(guestId)) {
                        alertState.delete(guestId);
                        renderList(allGuests); // Vuelve a dibujar para que regrese a verde si no se desmarcó.
                    }
                }, 3000); // 3 segundos para confirmar la desmarcación.
            }
        }
        
        // --- LÓGICA DE CARGA DE ARCHIVO Y PARSER ---
        
        /** * Parsea el archivo binario de Excel (XLSX/XLS) a un Array de Objetos.
         * ESPERA TRES COLUMNAS: Código Reserva, Cliente, Habitación.
         * AHORA BUSCA LA COLUMNA DE CHECK OUT.
         */
        function parseExcel(buffer) {
            try {
                // Lee el buffer binario como un libro de trabajo de Excel
                const workbook = XLSX.read(buffer, {type: 'array'});
                // Toma la primera hoja
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];

                // Convierte la hoja a formato JSON con encabezados como Array de Arrays
                const aoaData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1, // Obtiene los datos como Array of Arrays
                    raw: false, 
                    defval: '' // Usa cadena vacía para celdas nulas
                });
                
                if (aoaData.length <= 1) return []; // Solo encabezado o vacío

                // La primera fila es el encabezado
                const headers = aoaData[0].map(h => h ? h.trim() : '');
                
                const data = [];

                // Buscamos las columnas por nombre para hacer el parser más robusto a cambios de orden
                const colIndex = {
                    reservationCode: -1,
                    name: -1,
                    room: -1
                    // checkout: -1 // ELIMINADO
                };
                
                // --- BÚSQUEDA DE COLUMNAS POR COINCIDENCIA ---
                headers.forEach((header, index) => {
                    const normalizedHeader = normalizeStringForSearch(header);
                    
                    // Detección de Código de Reserva
                    if (normalizedHeader.includes('codigo') && normalizedHeader.includes('reserva')) {
                        colIndex.reservationCode = index;
                    } 
                    // Detección de Cliente
                    else if (normalizedHeader.includes('cliente')) {
                        colIndex.name = index;
                    } 
                    // Detección de Habitación
                    else if (normalizedHeader.includes('habitacion') || normalizedHeader.includes('hab')) {
                        colIndex.room = index;
                    } 
                });
                

                // Validación estricta de que se encontraron las columnas necesarias
                if (colIndex.reservationCode === -1 || colIndex.name === -1 || colIndex.room === -1) {
                    window.showNotification("Error de formato: No se encontraron las columnas 'Código Reserva', 'Cliente' o 'Habitación' en la primera hoja.", 'error');
                    return [];
                }

                // Iteramos desde la segunda fila (i=1) para ignorar el encabezado
                for (let i = 1; i < aoaData.length; i++) {
                    const row = aoaData[i];
                    
                    const cleanReservationCode = row[colIndex.reservationCode] ? row[colIndex.reservationCode].toString().trim() : '';
                    const cleanName = row[colIndex.name] ? row[colIndex.name].toString().trim() : '';
                    const cleanRoom = row[colIndex.room] ? row[colIndex.room].toString().trim() : '';
                    
                    // Validación básica
                    if (cleanReservationCode && cleanName) {
                        data.push({
                            reservationCode: cleanReservationCode,
                            name: toTitleCase(cleanName), // Aplicamos formato
                            room: cleanRoom,
                            // checkout: cleanCheckout, // ELIMINADO
                            isChecked: false 
                        });
                    }
                }
                return data;

            } catch (error) {
                console.error("Error al parsear Excel:", error);
                window.showNotification("Error: El archivo Excel está dañado o mal formateado.", 'error');
                return [];
            }
        }
        
        /** Maneja la subida del archivo XLSX/XLS y lo parsea. */
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();

            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls') && !fileName.endsWith('.xlsm') && !fileName.endsWith('.xlsb') && !fileName.endsWith('.ods')) {
                window.showNotification("Por favor, suba un archivo Excel o de hoja de cálculo válido.", 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const buffer = e.target.result;
                const data = parseExcel(buffer); // Llamamos al nuevo parser de Excel

                if (data.length === 0) {
                    window.showNotification("El archivo Excel está vacío o no se pudieron extraer los datos. Revise el formato de la primera hoja.", 'error');
                    return;
                }
                
                parsedGuestData = data;
                window.showConfirmModal(data.length);
            };
            
            // Leemos el archivo como un ArrayBuffer, necesario para SheetJS
            reader.readAsArrayBuffer(file);
            event.target.value = null; 
        }
        
        // --- LÓGICA DE MODAL DE CONFIRMACIÓN ---

        const modal = document.getElementById('upload-confirm-modal');
        const modalCount = document.getElementById('modal-guest-count');
        const modalConfirmButton = document.getElementById('modal-confirm-button');

        window.showConfirmModal = function(count) {
            modalCount.textContent = count;
            modal.classList.remove('hidden');
            
            // Re-adjuntar el listener para evitar duplicados
            modalConfirmButton.onclick = async () => {
                window.closeConfirmModal();
                // 1. Archivar estado actual + Borrar lista vieja + Cargar lista nueva
                await initializeGuestData(parsedGuestData); 
                parsedGuestData = []; // Limpiar la data temporal
            };
        }

        window.closeConfirmModal = function() {
            modal.classList.add('hidden');
        }

        // --- LÓGICA DE RENDERIZADO (MANTENIDO) ---

        /** Filtra la lista de huéspedes en base al término de búsqueda actual. */
        window.searchGuests = function(searchTerm) {
            // Se actualiza el término de búsqueda global
            currentSearchTerm = searchTerm.toLowerCase().trim();
            
            // Disparamos la renderización para que use el nuevo filtro inmediatamente
            renderList(allGuests);
        }

        /** Renderiza la lista de huéspedes en el contenedor. */
        function renderList(guests) {
            const container = document.getElementById('guest-list-container');
            const countDisplay = document.getElementById('guest-count');
            const enteredCountDisplay = document.getElementById('entered-count'); 
            
            if (!container) return;
            
            const guestsToRender = currentSearchTerm 
                ? guests.filter(guest => {
                    // Normaliza el término de búsqueda
                    const normalizedTerm = window.normalizeStringForSearch(currentSearchTerm);
                    
                    // Normaliza los campos de huésped para la comparación
                    const normalizedName = window.normalizeStringForSearch(guest.name);
                    const normalizedRoom = window.normalizeStringForSearch(guest.room);
                    
                    // LÓGICA CORREGIDA: Solo buscar por Nombre y Habitación
                    return normalizedName.includes(normalizedTerm) || 
                           normalizedRoom.includes(normalizedTerm);
                })
                : guests;

            const enteredCount = allGuests.filter(guest => guest.isChecked).length;
            
            countDisplay.textContent = `Total de Huéspedes: ${allGuests.length}`;
            enteredCountDisplay.textContent = `Ingresados: ${enteredCount}`;
            
            if (guestsToRender.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8">No se encontraron huéspedes con esa búsqueda.</p>';
                return;
            }

            const html = guestsToRender.map(guest => {
                const checked = guest.isChecked;
                const isAlert = alertState.has(guest.id); // Verifica si este huésped está en estado de alerta
                
                let cardClasses = "guest-card w-full p-3 flex justify-between items-center rounded-xl shadow-md cursor-pointer select-none border-l-8";
                let checkButtonClasses = "check-button flex items-center justify-center";
                let nameClasses = "text-lg font-bold truncate";
                let statusClasses = "text-xs mt-1 uppercase";
                let iconHtml;

                if (isAlert) {
                    cardClasses += " guest-card-alert"; // Usa el nuevo estilo naranja
                    checkButtonClasses += " bg-orange-500 hover:bg-orange-600";
                    nameClasses += " text-orange-700";
                    statusClasses += " text-orange-600 font-bold";
                    iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`; // Icono de alerta
                } else if (checked) {
                    cardClasses += " guest-card-checked";
                    checkButtonClasses += " bg-green-500 hover:bg-green-600";
                    nameClasses += " text-green-700";
                    statusClasses += " text-green-500 font-bold";
                    iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                } else {
                    cardClasses += " guest-card-unchecked";
                    checkButtonClasses += " bg-gray-200 hover:bg-gray-300";
                    nameClasses += " text-gray-900";
                    statusClasses += " text-red-500 font-semibold";
                    iconHtml = `<svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>`;
                }


                return `
                    <div class="${cardClasses}" onclick="window.toggleCheckin('${guest.id}', ${checked})">
                        <!-- Información del Huésped --><div class="flex-grow min-w-0 pr-4">
                            <p class="${nameClasses}">
                                ${guest.name}
                            </p>
                            <!-- ELIMINADA LA SECCIÓN DE CHECK-OUT --><div class="flex items-center text-xs text-gray-500 mt-1">
                                <span class="text-base font-bold text-gray-700">Hab: <span class="font-extrabold">${guest.room}</span></span>
                                <span class="font-bold text-gray-400 mx-2">|</span>
                                <span class="text-xs text-gray-500 truncate">
                                    <span class="font-medium">${guest.reservationCode}</span>
                                </span>
                            </div>
                            <p class="${statusClasses}">
                                ${isAlert ? 'CONFIRMAR EGRESO' : (checked ? 'INGRESADO' : 'PENDIENTE DE INGRESO')}
                            </p>
                        </div>
                        
                        <!-- Toggle Button (Área de toque grande y circular) --><div class="${checkButtonClasses}">
                            ${iconHtml}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Iniciar la aplicación al cargar la ventana
        window.onload = initializeFirebase;

    </script>
</body>
</html>
